<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MyBeast.ViewModels.Diet"
             xmlns:models="clr-namespace:MyBeast.Models"
             x:Class="MyBeast.Views.Diet.MealEditorPage"
             Title="{Binding PageTitle}"
             BackgroundColor="#1C1C1E">

    <Grid RowDefinitions="Auto, *, Auto, Auto">

        <VerticalStackLayout Grid.Row="0" Spacing="10" Padding="20">
            <Label Text="Nome e Horário" TextColor="Gray" FontSize="12"/>
            <Grid ColumnDefinitions="*, Auto" ColumnSpacing="10">
                <Entry Grid.Column="0" Text="{Binding Name}" TextColor="White" BackgroundColor="#2C2C2E" Placeholder="Ex: Almoço" />
                <TimePicker Grid.Column="1" Time="{Binding Time}" TextColor="White" BackgroundColor="#2C2C2E"/>
            </Grid>
            <BoxView HeightRequest="1" Color="#333" Margin="0,5"/>
        </VerticalStackLayout>

        <CollectionView Grid.Row="1" ItemsSource="{Binding FoodItems}" Margin="20,0">
            <CollectionView.Header>
                <Label Text="Itens do Prato" TextColor="Gray" FontSize="12" Margin="0,0,0,5"/>
            </CollectionView.Header>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:FoodItem">
                    <Grid ColumnDefinitions="*, 80, 40" Margin="0,0,0,10">
                        <Border Grid.Column="0" BackgroundColor="#2C2C2E" StrokeShape="RoundRectangle 8" Padding="10,0" Margin="0,0,5,0">
                            <Entry Text="{Binding Name}" TextColor="White" BackgroundColor="Transparent"/>
                        </Border>
                        <Border Grid.Column="1" BackgroundColor="#2C2C2E" StrokeShape="RoundRectangle 8" Padding="5,0" Margin="0,0,5,0">
                            <Entry Text="{Binding Kcal}" Keyboard="Numeric" TextColor="#FFA500" BackgroundColor="Transparent" HorizontalTextAlignment="Center"/>
                        </Border>
                        <Button Grid.Column="2" Text="-" BackgroundColor="#FF453A" TextColor="White" Padding="0" CornerRadius="8"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MealEditorViewModel}}, Path=RemoveItemCommand}"
                                CommandParameter="{Binding .}"/>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <VerticalStackLayout Grid.Row="2" Padding="20,10" BackgroundColor="#252525" Spacing="10">

            <Label Text="Adicionar Alimento" TextColor="Gray" FontSize="12"/>

            <Border BackgroundColor="#2C2C2E" StrokeShape="RoundRectangle 20" Padding="10,0">
                <Grid ColumnDefinitions="30, *">
                    <Image Source="search_icon.png" HeightRequest="20" VerticalOptions="Center" Opacity="0.5"/>
                    <Entry Grid.Column="1" 
                   Placeholder="Busque (ex: Banana) ou digite..." 
                   Text="{Binding SearchText}" 
                   TextColor="White"
                   BackgroundColor="Transparent"
                   ClearButtonVisibility="WhileEditing"/>
                </Grid>
            </Border>

            <CollectionView ItemsSource="{Binding SearchResults}" 
                    HeightRequest="150"
                    IsVisible="{Binding SearchResults.Count, Converter={StaticResource IntToBoolConverter}}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:FoodItem">
                        <Frame BackgroundColor="#3A3A3C" Padding="10" Margin="0,0,0,5" CornerRadius="5" BorderColor="Gray">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MealEditorViewModel}}, Path=SelectFoodCommand}"
                                              CommandParameter="{Binding .}"/>
                            </Frame.GestureRecognizers>
                            <Grid ColumnDefinitions="*, Auto">
                                <Label Text="{Binding Name}" TextColor="White" FontAttributes="Bold" VerticalOptions="Center"/>
                                <Label Text="{Binding Kcal, StringFormat='{0} kcal'}" TextColor="#FFA500" VerticalOptions="Center"/>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Button Text="+ Não achei, adicionar manualmente"
            Command="{Binding AddNewItemCommand}"
            BackgroundColor="Transparent"
            TextColor="#FF4081"
            FontSize="12"
            HeightRequest="40"
            HorizontalOptions="Start"/>

        </VerticalStackLayout>

        <VerticalStackLayout Grid.Row="3" Padding="20" Spacing="15" BackgroundColor="#1C1C1E">
            <Border BackgroundColor="#5A2E8B" StrokeShape="RoundRectangle 10" Padding="15">
                <Grid ColumnDefinitions="*, Auto">
                    <Label Text="TOTAL" TextColor="White" FontAttributes="Bold" VerticalOptions="Center"/>
                    <Label Grid.Column="1" Text="{Binding TotalCalories, StringFormat='{0} kcal'}" TextColor="White" FontSize="20" FontAttributes="Bold"/>
                </Grid>
            </Border>
            <Button Text="SALVAR" Command="{Binding SaveCommand}" BackgroundColor="#FF4081" TextColor="White" FontAttributes="Bold" CornerRadius="25" HeightRequest="50"/>
        </VerticalStackLayout>

    </Grid>
</ContentPage>