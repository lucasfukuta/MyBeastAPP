<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MyBeast.ViewModels.Diet"
             x:Class="MyBeast.Views.Diet.DietPage"
             Title="Minha Dieta"
             BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource OffBlack}}">

    <Grid>
        <Grid RowDefinitions="Auto, Auto, *">

            <Grid Grid.Row="0" ColumnDefinitions="Auto, *, Auto" Padding="20,10" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Black}}">
                <ImageButton Command="{Binding PreviousDateCommand}" HeightRequest="30" WidthRequest="30">
                    <ImageButton.Source>
                        <FontImageSource Glyph="&lt;" FontFamily="OpenSansRegular" Color="{StaticResource Primary}"/>
                    </ImageButton.Source>
                </ImageButton>

                <Label Text="{Binding CurrentDateDisplay, StringFormat='{0:D}'}" 
                 HorizontalOptions="Center" VerticalOptions="Center" 
                 FontAttributes="Bold" FontSize="16"/>

                <ImageButton Command="{Binding NextDateCommand}" HeightRequest="30" WidthRequest="30">
                    <ImageButton.Source>
                        <FontImageSource Glyph="&gt;" FontFamily="OpenSansRegular" Color="{StaticResource Primary}"/>
                    </ImageButton.Source>
                </ImageButton>
            </Grid>

            <Frame Grid.Row="1" Margin="15" CornerRadius="15" HasShadow="True" 
                   BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray950}}"
                   BorderColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray900}}">
                <VerticalStackLayout Spacing="10">
                    <Grid ColumnDefinitions="*, Auto">
                        <Label Text="Calorias Diárias" FontAttributes="Bold" FontSize="16"/>
                        <Label Grid.Column="1">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="{Binding CurrentCalories, StringFormat='{0:F0}'}" FontAttributes="Bold" TextColor="{StaticResource Primary}"/>
                                    <Span Text="{Binding TargetCalories, StringFormat=' / {0:F0} kcal'}" TextColor="{StaticResource Gray500}"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                    </Grid>

                    <ProgressBar Progress="{Binding CaloriesProgress}" 
                                 ProgressColor="{StaticResource Primary}" ScaleY="1.5"/>

                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10" Margin="0,10,0,0">
                        <VerticalStackLayout>
                            <Label Text="Proteína" HorizontalOptions="Center" FontSize="12" TextColor="{StaticResource Gray500}"/>
                            <Label Text="{Binding CurrentProtein, StringFormat='{0:F0}g'}" HorizontalOptions="Center" FontAttributes="Bold"/>
                            <BoxView Color="#4CAF50" HeightRequest="4" CornerRadius="2" Margin="10,2"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="1">
                            <Label Text="Carbo" HorizontalOptions="Center" FontSize="12" TextColor="{StaticResource Gray500}"/>
                            <Label Text="{Binding CurrentCarbs, StringFormat='{0:F0}g'}" HorizontalOptions="Center" FontAttributes="Bold"/>
                            <BoxView Color="#FFC107" HeightRequest="4" CornerRadius="2" Margin="10,2"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="2">
                            <Label Text="Gordura" HorizontalOptions="Center" FontSize="12" TextColor="{StaticResource Gray500}"/>
                            <Label Text="{Binding CurrentFat, StringFormat='{0:F0}g'}" HorizontalOptions="Center" FontAttributes="Bold"/>
                            <BoxView Color="#F44336" HeightRequest="4" CornerRadius="2" Margin="10,2"/>
                        </VerticalStackLayout>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <CollectionView Grid.Row="2" ItemsSource="{Binding DailyMeals}" Margin="15,0,15,80">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="viewmodels:MealEntryDisplay">
                        <VerticalStackLayout Spacing="5" Margin="0,0,0,20">
                            <Grid ColumnDefinitions="*, Auto">
                                <Label Text="{Binding MealType}" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource Primary}"/>
                                <Label Grid.Column="1" Text="{Binding TotalCalories, StringFormat='{0:F0} kcal'}" VerticalOptions="Center" FontSize="12" TextColor="{StaticResource Gray500}"/>
                            </Grid>
                            <Frame Padding="0" CornerRadius="10" HasShadow="False" BorderColor="{StaticResource Gray200}">
                                <StackLayout BindableLayout.ItemsSource="{Binding Items}">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="viewmodels:MealItemDisplay">
                                            <SwipeView>
                                                <SwipeView.RightItems>
                                                    <SwipeItems>
                                                        <SwipeItem Text="Excluir" 
                                                                   BackgroundColor="#FF5252"
                                                                   Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:DietViewModel}}, Path=RemoveItemCommand}"
                                                                   CommandParameter="{Binding .}"/>
                                                    </SwipeItems>
                                                </SwipeView.RightItems>
                                                <Grid ColumnDefinitions="*, Auto" Padding="15,10" BackgroundColor="Transparent">
                                                    <VerticalStackLayout>
                                                        <Label Text="{Binding Food.Name}" FontSize="14"/>
                                                        <Border IsVisible="{Binding Food.IsCustom}" 
                                                                StrokeShape="RoundRectangle 4" 
                                                                BackgroundColor="{StaticResource Secondary}"
                                                                HorizontalOptions="Start"
                                                                StrokeThickness="0"
                                                                Padding="4,2"
                                                                Margin="0,2,0,0">
                                                            <Label Text="My Food" FontSize="10" TextColor="White"/>
                                                        </Border>
                                                    </VerticalStackLayout>
                                                    <Label Grid.Column="1" Text="{Binding TotalItemCalories, StringFormat='{0:F0} kcal'}" VerticalOptions="Center" TextColor="{StaticResource Gray400}"/>
                                                </Grid>
                                            </SwipeView>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </StackLayout>
                            </Frame>
                        </VerticalStackLayout>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <Grid BackgroundColor="#CC000000" IsVisible="{Binding IsAddFormVisible}" Padding="20">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding ToggleAddFormCommand}"/>
            </Grid.GestureRecognizers>

            <Frame VerticalOptions="Center" CornerRadius="20" Padding="20"
                   BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray950}}">
                <Frame.GestureRecognizers>
                    <TapGestureRecognizer />
                </Frame.GestureRecognizers>

                <VerticalStackLayout Spacing="15">
                    <Grid ColumnDefinitions="*, Auto">
                        <Label Text="Novo Alimento" FontSize="20" FontAttributes="Bold" VerticalOptions="Center"/>

                        <Button Grid.Column="1" 
                                Text="✕" 
                                Command="{Binding ToggleAddFormCommand}"
                                BackgroundColor="Transparent" 
                                TextColor="{StaticResource Gray500}"
                                FontSize="18"
                                HeightRequest="40"
                                WidthRequest="40"/>
                    </Grid>

                    <Entry Placeholder="Nome do Alimento" Text="{Binding NewItemName}" />

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <Picker Title="Refeição" ItemsSource="{Binding AvailableMealTypes}" SelectedItem="{Binding SelectedMealType}" Grid.Column="0"/>
                        <Entry Placeholder="Qtd" Keyboard="Numeric" Text="{Binding NewItemQuantity}" Grid.Column="1"/>
                    </Grid>

                    <Label Text="Macros (por porção)" FontSize="12" TextColor="{StaticResource Gray500}"/>
                    <Grid ColumnDefinitions="*,*,*,*" ColumnSpacing="5">
                        <Entry Placeholder="Kcal" Keyboard="Numeric" Text="{Binding NewItemCalories}" Grid.Column="0"/>
                        <Entry Placeholder="Prot" Keyboard="Numeric" Text="{Binding NewItemProtein}" Grid.Column="1"/>
                        <Entry Placeholder="Carb" Keyboard="Numeric" Text="{Binding NewItemCarbs}" Grid.Column="2"/>
                        <Entry Placeholder="Gord" Keyboard="Numeric" Text="{Binding NewItemFat}" Grid.Column="3"/>
                    </Grid>

                    <Button Text="Salvar Alimento" 
                            Command="{Binding SaveMealCommand}" 
                            BackgroundColor="{StaticResource Primary}" 
                            TextColor="White"
                            Margin="0,10,0,0"/>
                </VerticalStackLayout>
            </Frame>
        </Grid>

        <Button Text="+" 
                Command="{Binding ToggleAddFormCommand}"
                BackgroundColor="{StaticResource Primary}" 
                TextColor="White"
                FontSize="24"
                CornerRadius="30"
                WidthRequest="60"
                HeightRequest="60"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="20"
                Shadow="{Shadow Brush=Black, Offset='2,2', Radius=5, Opacity=0.3}"
                IsVisible="{Binding IsAddButtonVisible}"/>

    </Grid>
</ContentPage>